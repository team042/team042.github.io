<html>
<head>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <!-- sourcing add-ons for jquery-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>
	<script src="nouislider.min.js"></script>
    <link rel="stylesheet" href="nouislider.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
		/* body {
			margin: 0;
			padding: 0;
		} */
		#overlay{
			position: absolute;
			z-index: 999;
			background: rgba(255, 255, 255, 0.7);
			padding: 10px;
			right: 0;
			margin: 10px;
			border-radius: 10px;
			box-shadow: 1px 1px 1px grey;
			min-height: 200px;
			width: 250px;
			display: flex;
			flex-direction: column;
			align-items: center;
		}
		.slider {
			width: 200px;
			margin-top: 50px;
			margin-bottom: 50px;
		}
	</style>
</head>
<body>

	<div id="overlay">
		<h2>Map Options</h2>
		<p><u>Event Search</u></p>
		<input id="event-search" type="text" />
		<p><u>Route Type</u></p>
		<input id="commodity-search" type="text" />
		<p><u>Route Spend</u></p>
		<div id="commodity-slider" class="slider"></div>
		<p><u>Route Year</u></p>
		<div id="year-slider" class="slider"></div>
		<p><u>Minimum Event Scale</u></p>
		<div id="event-slider" class="slider"></div>
	</div>
    <div id="map" style="width:100%;"></div>

    <script>
		$('#map').height(window.innerHeight);
        var map = L.map('map').setView([17.410199787878017, 26.73338651585506], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'}).addTo(map);
        map.options.minZoom = 3;
        var southWest = L.latLng(-89.98155760646617, -300),
        northEast = L.latLng(89.99346179538875, 350);
        var bounds = L.latLngBounds(southWest, northEast);
        map.setMaxBounds(bounds);
        
		
		eventsGeoJSON = false

        // create empty marker cluster group
		var markers = L.markerClusterGroup()

		fetch('/events.geojson', {
			method: 'GET'
		})
		.then(response => response.json())
		.then(json => {
			// var eventScaleMin = 0
			// var eventScaleMax = 0
			eventsGeoJSON = L.geoJSON(json, {
				pointToLayer: function(geoJsonPoint, latlng){
					// Get min/max
					// if(geoJsonPoint.properties['scale']<eventScaleMin || eventScaleMin === 0){
					// 	eventScaleMin = geoJsonPoint.properties['scale']
					// 	console.log(eventScaleMin)
					// }
					// if(geoJsonPoint.properties['scale']>eventScaleMax){
					// 	eventScaleMax = geoJsonPoint.properties['scale']
					// }
					var html='';
					var arrayOfProps=['dyad_name','Total_deaths','date_start','date_end','scale'];
					arrayOfProps.forEach(function(prop){
						if (prop == "dyad_name"){
							html += '<strong>Event Name</strong>: ' +geoJsonPoint.properties[prop]+'<br />';							
						}
						if (prop == "Total_deaths"){
							html += '<strong>Total Deaths</strong>: ' +geoJsonPoint.properties[prop]+'<br />';							
						}
						if (prop == "date_start"){
							html += '<strong>Start Date</strong>: ' +geoJsonPoint.properties[prop]+'<br />';							
						}
						if (prop == "date_end"){
							html += '<strong>End Date</strong>: ' +geoJsonPoint.properties[prop]+'<br />';							
						}
						if (prop == "scale"){
							html += '<strong>Event Scale</strong>: ' +geoJsonPoint.properties[prop]+'<br />';							
						}
					})
					return L.marker(latlng).bindPopup(html)
				}
			})
			markers.addLayer(eventsGeoJSON);
			})
		.catch(error => console.log(error.message))
		markers.addTo(map)
        
		routesGeoJSON = false
		// Create layer group for routes
		var allRoutes = L.layerGroup()

		fetch('/sc_routes.geojson', {
			method: 'GET'
		})
		.then(response => response.json())
		.then(json => {
			console.log(json)
			routesGeoJSON = L.geoJSON(json, {
				style: function (feature) {
					if (feature.properties["route_type"] == "sea"){
						return {
							color: "blue"
						}
					}
					if (feature.properties["route_type"] == "Road"){
						return {
							color: "green"
						}
					}
					if (feature.properties["route_type"] == "Air"){
						return {
							color: "grey"
						}
					}
				},
				onEachFeature: function(feature, layer) {
					html = ''
					var arrayOfProps=['route_ID','orig_ISO','dest_ISO','weight','route_type', 'period', 'max_good.commodity','total_value'];
					arrayOfProps.forEach(function(prop){
						if (prop == "route_ID"){
							html += '<strong>Route ID</strong>: ' +feature.properties[prop]+'<br />';							
						}
						if (prop == "orig_ISO"){
							html += '<strong>Route Origin</strong>: ' +feature.properties[prop]+'<br />';							
						}
						if (prop == "dest_ISO"){
							html += '<strong>Route Destination</strong>: ' +feature.properties[prop]+'<br />';							
						}
						if (prop == "weight"){
							html += '<strong>Route Weight</strong>: ' +feature.properties[prop]+'<br />';							
						}
						if (prop == "route_type"){
							html += '<strong>Route Type</strong>: ' +feature.properties[prop]+'<br />';							
						}
						if (prop == "period"){
							html += '<strong>Route Year</strong>: ' +feature.properties[prop]+'<br />';							
						}
						if (prop == "max_good.commodity"){
							html += '<strong>Highest Spend Good</strong>: ' +feature.properties["max_good"]["commodity"]+'<br />';							
						}
						if (prop == "total_value"){
							html += '<strong>Route Spend (USD)</strong>: ' +feature.properties[prop]+'<br />';							
						}
					})
					return layer.bindPopup(html)
				}
			})
			allRoutes.addLayer(routesGeoJSON);
		})
		.catch(error => console.log(error.message))

		allRoutes.addTo(map)

		$(document).on('keyup', '#event-search', function(e) {
			var userInput = e.target.value;
			eventsGeoJSON.eachLayer(function(layer){
				if(layer.feature.properties.dyad_name.toLowerCase().indexOf(userInput.toLowerCase())>-1){
					markers.addLayer(layer);
				} else {
					markers.removeLayer(layer);
				}
				// console.log(layer)
			})
		})

		$(document).on('keyup', '#commodity-search', function(e) {
			var userInput = e.target.value;
			routesGeoJSON.eachLayer(function(layer){
				if(layer.feature.properties.route_type.toLowerCase().indexOf(userInput.toLowerCase())>-1){
					allRoutes.addLayer(layer);
				} else {
					allRoutes.removeLayer(layer);
				}
			})
		})

		// console.log(eventScaleMin, eventScaleMax)
		var eventSlider = document.getElementById('event-slider');
		noUiSlider.create(eventSlider, {
			tooltips: true,
			start: [20],
			connect: true,
			range: {
				'min': 0,
				'max': 12000000
			}
		}).on('slide', function(e) {
			eventsGeoJSON.eachLayer(function(layer) {
				if(layer.feature.properties.scale>=parseFloat(e[0])){
					markers.addLayer(layer);
				} else {
					markers.removeLayer(layer);
				}
			}
		)});

		var commoditySlider = document.getElementById('commodity-slider');
		noUiSlider.create(commoditySlider, {
			tooltips: true,
			start: [20, 20000000],
			connect: true,
			range: {
				'min': 0,
				'max': 100
			}
		}).on('slide', function(e) {

		});

		var yearSlider = document.getElementById('year-slider');
		noUiSlider.create(yearSlider, {
			tooltips: true,
			start: [20, 20000000],
			connect: true,
			range: {
				'min': 0,
				'max': 100
			}
		}).on('slide', function(e) {

		});
    </script>
</body>
</html>